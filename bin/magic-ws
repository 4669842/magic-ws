#!/bin/sh

MAGIC_WS_PATH="$_"

magic_ws_has() {
  type "${1-}" > /dev/null 2>&1
}

# Make zsh glob matching behave same as bash
# This fixes the "zsh: no matches found" errors
if [ -z "${MAGIC_WS_CD_FLAGS-}" ]; then
  export MAGIC_WS_CD_FLAGS=''
fi
if magic_ws_has "unsetopt"; then
  unsetopt nomatch 2>/dev/null
  MAGIC_WS_CD_FLAGS="-q"
fi

# Auto detect the MAGIC_WS_DIR when not set
if [ -z "${MAGIC_WS_DIR-}" ]; then
  # shellcheck disable=SC2128
  if [ -n "${BASH_SOURCE-}" ]; then
    # shellcheck disable=SC2169
    MAGIC_WS_PATH="${BASH_SOURCE[0]}"
  fi
  # shellcheck disable=SC1001
  MAGIC_WS_DIR="$(cd ${MAGIC_WS_CD_FLAGS} "$(dirname "${MAGIC_WS_PATH:-$0}")" > /dev/null && \pwd)"
  export MAGIC_WS_DIR
fi
unset MAGIC_WS_PATH 2> /dev/null

# SEARCH_PATH is where our node lives.
MAGIC_WS_NODE_SEARCH_PATH=${MAGIC_WS_DIR}/helpers

# BOOTSTRAP_PATH
MAGIC_WS_BOOTSTRAP_PATH=$(dirname "$MAGIC_WS_DIR")/magic-ws-2.js

export MAGIC_WS_BOOTSTRAP_PATH

MAGIC_WS_REAL_NODE=`which node` export MAGIC_WS_REAL_NODE
PATH=${MAGIC_WS_NODE_SEARCH_PATH}:${PATH} export PATH

MAGIC_WS_BOOTSTRAP_ARGS=""

while (( "$#" )); do

    if [ $1 = "-p" -o $1 = "--package" -o $1 = "-w" -o $1 = "--workspace" ]; then

        ARG_LENGTH=`expr "$1" : ".*"`
        MAGIC_WS_BOOTSTRAP_ARGS="$MAGIC_WS_BOOTSTRAP_ARGS$ARG_LENGTH;$1"
        shift

        ARG_LENGTH=`expr "$1" : ".*"`
        MAGIC_WS_BOOTSTRAP_ARGS="$MAGIC_WS_BOOTSTRAP_ARGS$ARG_LENGTH;$1"
        shift

    elif [ $1 = "-b" -o $1 = "--babel" ]; then

        ARG_LENGTH=`expr "$1" : ".*"`
        MAGIC_WS_BOOTSTRAP_ARGS="$MAGIC_WS_BOOTSTRAP_ARGS$ARG_LENGTH;$1"
        shift
    
    else

        break;
    fi
done

export MAGIC_WS_BOOTSTRAP_ARGS

$@
